{% extends 'base.html' %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Welcome, {{ user.first_name }} {{ user.last_name }}</h1>
    <p class="text-center">Your personalized workout dashboard is below.</p>

    <!-- Upcoming Workouts Section -->
    <div class="mt-5">
        <h2 class="mb-3">Upcoming Workouts</h2>
        <canvas id="upcomingWorkoutsChart" width="400" height="200"></canvas>
    </div>

    <!-- Recent Workouts Section -->
    <div class="mt-5">
        <h2 class="mb-3">Recent Workouts</h2>
        <canvas id="recentWorkoutsChart" width="400" height="200"></canvas>
    </div>

    <!-- Your Progress Section -->
    <div class="mt-5">
        <h2 class="mb-3">Your Progress</h2>
        <div class="alert alert-info">
            <p><strong>Workouts Completed:</strong> {{ completed_workouts }}</p>
            <p><strong>Total Hours Spent:</strong> {{ hours_spent }}</p>
        </div>
    </div>

    <!-- Goals Section -->
    <div class="mt-5">
        <h2 class="mb-3">Your Goals</h2>
        {% if active_goals %}
            <ul class="list-group">
                {% for goal in active_goals %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ goal.name }}</strong>: {{ goal.progress }}/{{ goal.target }}
                        ({{ goal.percentage_complete|floatformat:2 }}%)
                        {% if goal.due_date %}
                        <p class="text-muted">Due by: {{ goal.due_date }}</p>
                        {% endif %}
                    </div>
                    <a href="{% url 'goals:edit_goal' goal.id %}" class="btn btn-sm btn-link">Edit</a>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">No active goals. Set a new one today!</p>
        {% endif %}
        <a href="{% url 'goals:create_goal' %}" class="btn btn-primary mt-3">Add a New Goal</a>
    </div>

    <!-- Workout History Section -->
    <div class="mt-5">
        <h2 class="mb-3">Workout History</h2>
        <p>View all of your past workouts in detail.</p>
        <a href="{% url 'workouts:workout_history' %}" class="btn btn-secondary">View All Past Workouts</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        fetch("{% url 'users:get_workout_data' %}")
            .then(response => response.json())
            .then(data => {
                // Upcoming Workouts Chart
                const upcomingLabels = data.upcoming_workouts.map(workout => workout.date);
                const upcomingIntensities = data.upcoming_workouts.map(workout => workout.intensity);
                const upcomingColors = data.upcoming_workouts.map(workout => {
                    if (workout.intensity === "High") return "rgba(255, 99, 132, 0.8)";
                    if (workout.intensity === "Moderate") return "rgba(255, 206, 86, 0.8)";
                    return "rgba(75, 192, 192, 0.8)";
                });

                new Chart(document.getElementById('upcomingWorkoutsChart'), {
                    type: 'bar',
                    data: {
                        labels: upcomingLabels,
                        datasets: [{
                            label: 'Workout Intensity',
                            data: Array(upcomingLabels.length).fill(1),
                            backgroundColor: upcomingColors,
                            borderColor: upcomingColors.map(color => color.replace(/0\.8/, "1")),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (tooltipItem) => upcomingIntensities[tooltipItem.dataIndex]
                                }
                            }
                        }
                    }
                });

                // Recent Workouts Chart
                const recentLabels = data.recent_workouts.map(workout => workout.date);
                const recentIntensities = data.recent_workouts.map(workout => workout.intensity);
                const recentColors = data.recent_workouts.map(workout => {
                    if (workout.intensity === "High") return "rgba(255, 99, 132, 0.8)";
                    if (workout.intensity === "Moderate") return "rgba(255, 206, 86, 0.8)";
                    return "rgba(75, 192, 192, 0.8)";
                });

                new Chart(document.getElementById('recentWorkoutsChart'), {
                    type: 'line',
                    data: {
                        labels: recentLabels,
                        datasets: [{
                            label: 'Workout Intensity',
                            data: recentIntensities.map(intensity => {
                                if (intensity === "High") return 3;
                                if (intensity === "Moderate") return 2;
                                return 1;
                            }),
                            backgroundColor: recentColors,
                            borderColor: recentColors.map(color => color.replace(/0\.8/, "1")),
                            borderWidth: 2,
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => {
                                        if (value === 3) return 'High';
                                        if (value === 2) return 'Moderate';
                                        return 'Low';
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error("Error fetching workout data:", error));
    });
</script>
{% endblock %}
